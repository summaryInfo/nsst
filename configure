#!/bin/sh

use_ppoll=0
use_x11shm=1
use_boxdrawing=1
use_precompose=1
prefix=/usr/local
name=nsst
backend=x11shm
vars='CFLAGS = -O2 -flto'

case "$(uname)" in
    Linux) use_ppoll=1;;
    OpenBSD) use_ppoll=1;;
esac

help() {
cat <<END
Usage: configure [options]
    --name=NAME             binary name [$name]
    --prefix=DIR            installation prefix [$prefix]
    --mandir=DIR            man install directory [$prefix/share/man]
    --bindir=DIR            binary install directory [$prefix/bin]
    --enable-ppoll          enable ppoll in main loop for better timing [set if available]
    --disable-ppoll         disable ppoll in main loop, use poll instead
    --enable-boxdrawing     enable built-in box drawing characters [set]
    --disable-boxdrawing    disable built-in box drawing characters
    --enable-precompose     enable enable unicode combining characters precomposition [set]
    --disable-precompose    disable enable unicode combining characters precomposition
    --backend=<targ>        Rendering backend [x11shm]/x11xrender
END
}

IFS=''
nl='\
'

for i; do
    case "$i" in
    --enable-ppoll)
        use_ppoll=1 ;;
    --disable-ppoll)
        use_ppoll=0 ;;
    --enable-boxdrawing)
        use_boxdrawing=1 ;;
    --disable-boxdrawing)
        use_boxdrawing=0 ;;
    --enable-precompose)
        use_precompose=1 ;;
    --disable-precompose)
        use_precompose=0 ;;
    --backend=*)
        backend="${backend#--backend=}" ;;
    --name=*)
        name="${name#--name=}" ;;
    --bindir=*)
        bindir="${bindir#--bindir=}" ;;
    --mandir=*)
        mandir="${mandir#--mandir=}" ;;
    --prefix=*)
        prefix="${prefix#--prefix=}" ;;
    [A-Za-z_]*=*)
        vars="$vars$nl$i" ;;
    *)
        help
        exit 1 ;;
    esac
done

[ x = x"$bindir" ] && bindir=${prefix}/bin
[ x = x"$mandir" ] && mandir=${prefix}/share/man

deps="fontconfig freetype2 xkbcommon"
objs="nsst.o util.o font.o term.o config.o input.o nrcs.o"

case "$backend" in
x11shm)
    objs="$objs window-x11.o render-x11shm.o image.o"
    deps="$deps xcb xcb-xkb xcb-xrm xcb-shm xkbcommon-x11"
    use_x11shm=1
    ;;
x11xrender)
    objs="$objs window-x11.o render-x11xrender.o"
    deps="$deps xcb xcb-xkb xcb-xrm xcb-render xkbcommon-x11"
    use_x11shm=0
    ;;
*)
    echo "\tUnknown backend: '$backend'"
    help
    exit 1
    ;;
esac

if [ x"$use_boxdrawing" = x1 ]; then
    objs="$objs boxdraw.o"
fi

sed < "./feature.h.in" > "./feature.h" \
    -e "s:@USE_PPOLL@:$use_ppoll:g" \
    -e "s:@USE_BOXDRAWING@:$use_boxdrawing:g" \
    -e "s:@USE_X11SHM@:$use_x11shm:g" \
    -e "s:@USE_PRECOMPOSE@:$use_precompose:g"

sed < "./Makefile.in" > "./Makefile" \
    -e "s:@NAME@:$name:" \
    -e "s:@PREFIX@:$prefix:" \
    -e "s:@BINDIR@:$bindir:" \
    -e "s:@MANDIR@:$mandir:" \
    -e "s:@DEPS@:$deps:" \
    -e "s:@OBJECTS@:$objs:" \
    -e "s:@VARS@:$vars:"

cat <<END
    name..................... $name
    prefix................... $prefix
    bindir................... $bindir
    mandir................... $mandir
    backend.................. $backend
    boxdrawing............... $use_boxdrawing
    precompose............... $use_precompose
    ppoll.................... $use_ppoll

    Do "make && make install" to compile and install nsst
END
